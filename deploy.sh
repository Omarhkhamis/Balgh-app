#!/bin/bash

# ๐ ุณูุฑูุจุช ุงููุดุฑ ุงูุชููุงุฆู ูู Hostinger VPS
# ุงูุงุณุชุฎุฏุงู: ./deploy.sh

set -e  # ุฅููุงู ุนูุฏ ุฃู ุฎุทุฃ

# ุงูุฃููุงู
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ุฅุนุฏุงุฏุงุช ุงููุดุฑูุน
PROJECT_DIR="/var/www/balghapp"
APP_NAME="balghapp"
BRANCH="main"

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}๐ ุจุฏุก ุนูููุฉ ุงููุดุฑ ุงูุชููุงุฆู${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ ุงููุฌูุฏ
if [ ! -d "$PROJECT_DIR" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ุงููุฌูุฏ $PROJECT_DIR ุบูุฑ ููุฌูุฏ${NC}"
    exit 1
fi

cd $PROJECT_DIR

# 1. ุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub
echo -e "${BLUE}๐ฅ ุงูุฎุทูุฉ 1/6: ุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub...${NC}"
git fetch origin
git reset --hard origin/$BRANCH
echo -e "${GREEN}โ ุชู ุณุญุจ ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ${NC}"
echo ""

# 2. ุชุซุจูุช ุงูููุชุจุงุช
echo -e "${BLUE}๐ฆ ุงูุฎุทูุฉ 2/6: ุชุซุจูุช ุงูููุชุจุงุช...${NC}"
npm install --production=false
echo -e "${GREEN}โ ุชู ุชุซุจูุช ุงูููุชุจุงุช ุจูุฌุงุญ${NC}"
echo ""

# 3. ุจูุงุก ุงููุดุฑูุน
echo -e "${BLUE}๐จ ุงูุฎุทูุฉ 3/6: ุจูุงุก ุงููุดุฑูุน...${NC}"
NODE_OPTIONS="--max-old-space-size=4096" npm run build
echo -e "${GREEN}โ ุชู ุจูุงุก ุงููุดุฑูุน ุจูุฌุงุญ${NC}"
echo ""

# 4. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
echo -e "${BLUE}๐ ุงูุฎุทูุฉ 4/6: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู...${NC}"
pm2 restart $APP_NAME
echo -e "${GREEN}โ ุชู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู ุจูุฌุงุญ${NC}"
echo ""

# 5. ุญูุธ ุญุงูุฉ PM2
echo -e "${BLUE}๐พ ุงูุฎุทูุฉ 5/6: ุญูุธ ุญุงูุฉ PM2...${NC}"
pm2 save
echo -e "${GREEN}โ ุชู ุญูุธ ุงูุญุงูุฉ ุจูุฌุงุญ${NC}"
echo ""

# 6. ุนุฑุถ ุญุงูุฉ ุงูุชุทุจูู
echo -e "${BLUE}๐ ุงูุฎุทูุฉ 6/6: ุงูุชุญูู ูู ุญุงูุฉ ุงูุชุทุจูู...${NC}"
pm2 status $APP_NAME
echo ""

# ุนุฑุถ ุงูุณุฌูุงุช ุงูุฃุฎูุฑุฉ
echo -e "${BLUE}๐ ุงูุณุฌูุงุช ุงูุฃุฎูุฑุฉ:${NC}"
pm2 logs $APP_NAME --lines 10 --nostream
echo ""

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ุชู ุงููุดุฑ ุจูุฌุงุญ! ๐${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${YELLOW}๐ก ูุตูุญุฉ: ููุชุงุจุนุฉ ุงูุณุฌูุงุช ุงููุจุงุดุฑุฉุ ุงุณุชุฎุฏู:${NC}"
echo -e "   pm2 logs $APP_NAME"
echo ""
